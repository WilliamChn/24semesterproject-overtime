<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile Page</title>
<link rel="stylesheet" href="style.css">
<script>

document.addEventListener('DOMContentLoaded', (event) => {
    // Moved the fetchUserData function call here to ensure DOM is fully loaded
    fetchUserData();
});

// This function will fetch user data from profile-data.php including intakes and workouts
async function fetchUserData() {
    try {
        const response = await fetch('profile-data.php');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Now update the frontend with the fetched data
        document.getElementById('userWeight').innerText = `${data.weight} lbs`;
        document.getElementById('userHeight').innerText = `${data.height} in`;
        document.getElementById('userAge').innerText = `${data.age} years`;
        document.getElementById('proteinIntakeText').innerText = `${data.totalProtein} g`;
        document.getElementById('waterIntakeText').innerText = `${data.totalWater} ml`;
        document.getElementById('calorieIntake').innerText = `${data.totalCalories} cal`;

        updateWaterIntakeCircle(data.totalWater);
        updateProteinIntakeCircle(data.totalProtein);

        if(data.longestWorkout !== null) {
            document.getElementById('longestWorkoutBox').innerText = `${data.longestWorkout} mins`;
        }
        
        if(data.recentWorkout !== null) {
            document.getElementById('recentWorkout').innerText = `Style: ${data.recentWorkout.style}, Duration: ${data.recentWorkout.duration} mins`;
        } else {
            document.getElementById('recentWorkout').innerText = 'No recent workouts logged';
        }
    } catch (error) {
        console.error('There was a problem fetching the user data:', error);
    }
}

function updateProteinIntakeCircle(value) {
    var maxProtein = 200; // Set a maximum protein intake value for full circle
    var percentage = Math.min(value / maxProtein * 100, 100);
    var circle = document.getElementById('proteinIntakeCircle');
    var proteinText = document.getElementById('proteinIntakeText'); // Get the protein text element
    circle.style.background = `conic-gradient(lightgreen 0% ${percentage}%, lightgray ${percentage}% 100%)`;
    proteinText.innerText = value + ' g'; // Update the text

    // Show goal message if reached
    var goalMessage = document.getElementById('proteinGoalMessage');
    goalMessage.style.display = (value >= maxProtein) ? 'block' : 'none';
}

function updateWaterIntakeCircle(value) {
    var maxWater = 2000; // Adjust the maximum value based on your goal
    var percentage = Math.min(value / maxWater * 100, 100); // Calculate the fill percentage
    var circle = document.getElementById('waterIntakeCircle');
    var waterText = document.getElementById('waterIntakeText'); // Get the water text element
    circle.style.background = `conic-gradient(lightblue 0% ${percentage}%, lightgray ${percentage}% 100%)`;
    waterText.innerText = value + ' ml'; // Update the text

    // Show goal message if reached
    var goalMessage = document.getElementById('waterGoalMessage');
    goalMessage.style.display = (value >= maxWater) ? 'block' : 'none';
}

// Function to send water intake data to the server
function sendWaterIntakeData(waterIntake) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "profile-data.php", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fetchUserData(); // Refetch user data to update the display and the circle
        }
    };
    xhr.send("waterIntake=" + waterIntake);
}

// Function to validate the water intake input and send data if valid
function validateAndSendWaterIntake() {
    var waterIntakeInput = document.getElementById('waterIntakeInput');
    var waterIntakeValue = waterIntakeInput.value;
    if (isNaN(waterIntakeValue) || waterIntakeValue < 0 || waterIntakeValue === '') {
        alert('Please enter a valid number');
        waterIntakeInput.value = ''; // Clear the textbox
        waterIntakeInput.focus();
        return false;
    }
    sendWaterIntakeData(waterIntakeValue); // Send data if validation is successful
    waterIntakeInput.value = ''; // Clear the input box after sending data
}

</script>
</head>
<body>

    <header>
      <div class="navbar">
        <a href="../index.php">OVERTIME</a>
        <div class="navbar-right">
          <a href="../Meal_Page/index.html">Log Meals</a>
          <a href="../Workout_Page/index.html">Log Workouts</a>
          <a href="../Profile_Page/index.html">Profile</a>
          <a href="../logout.php">Logout</a> 
        </div>
      </div>
    </header>
    
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="header-content">
            <h1>MY PROFILE</h1>
        </div>
    </div>

    <!-- Profile Sections Container -->
    <div class="sections-container">

    <!-- Personal Section -->
    <div class="section personal">
        <h2 class="section-title">Personal</h2>
        <div class="data-field-container">
          <!-- Height -->
          <div class="data-section">
            <span class="data-label">Height</span>
            <span class="data-value" id="userHeight">6 ft 3 in
            </span>
          </div>
          <!-- Weight -->
          <div class="data-section">
            <span class="data-label">Weight</span>
            <span class="data-value" id="userWeight">150 lbs</span>
          </div>
          <!-- Age -->
          <div class="data-section">
            <span class="data-label">Age</span>
            <span class="data-value" id="userAge">21 years</span>
          </div>
          <!-- Calorie Intake -->
          <div class="data-section">
            <span class="data-label">Calorie Intake</span>
            <span class="data-value" id="calorieIntake">0 cal</span>
          </div>
          <!-- Water Intake -->
          <div class="data-field">
            <span class="data-label">Water Intake</span>
            <div class="circle-progress" id="waterIntakeCircle">
              <span id="waterIntakeText">0 ml</span>
            </div>
            <input type="text" id="waterIntakeInput" placeholder="Enter ml">
            <button type="button" onclick="validateAndSendWaterIntake()">Enter</button>
            <div class="goal-message" id="waterGoalMessage">Daily Goal Reached</div>
          </div>
          <!-- Protein Intake -->
          <div class="data-field">
            <span class="data-label">Protein Intake</span>
            <div class="circle-progress" id="proteinIntakeCircle">
              <span id="proteinIntakeText">0 g</span>
            </div>
          </div>
        </div>
      </div>
      

        <!-- Exercise Section -->
        <div class="section exercise">
          <h2 class="section-title">Exercise</h2>
          <div class="data-field-container">
              <div class="data-section">
                  <span class="data-label">Max Weight Lifted</span>
                  <span class="data-value">N/A</span>
              </div>
              <div class="data-section">
                <span class="data-label">Longest Workout</span>
                <span class="data-value" id="longestWorkoutBox">0 mins</span>
              </div>              
              <div class="data-section">
                <span class="data-label">Recent Workout</span>
                <div class="data-value" id="recentWorkout">Style: None, Duration: 0 mins</div> <!-- This will be dynamically updated -->
            </div>
          </div>
      </div>
  </div>

</body>
</html>
